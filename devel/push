#!/bin/bash
#
# Push the nextstrain/base and nextstrain/base-builder images to Docker Hub.
#
# By default this publishes the "latest" tag, but you can provide other tags in
# addition to or instead of "latest".
#
# Errors if a tagged image has already been pushed.
#
set -euo pipefail

# If no tags are given, default to "latest".
if [[ $# -eq 0 ]]; then
    set -- latest
fi

BASE_IMAGE="nextstrain/base"
BASE_BUILDER_IMAGE="nextstrain/base-builder"

for tag in "$@"; do

    if [[ $(docker image inspect --format "{{.RepoDigests}}" $BASE_IMAGE:$tag) != '[]' || $(docker image inspect --format "{{.RepoDigests}}" $BASE_BUILDER_IMAGE:$tag) != '[]' ]]; then
        echo "At least one of the tagged images has already been pushed. This can happen if the newly built image is not available in the local registry." >&2
        exit 1
    fi

    docker push $BASE_BUILDER_IMAGE:$tag
    docker push $BASE_IMAGE:$tag
done
